# .github/workflows/backend-ci.yml
name: Backend CI

on:
  workflow_call:
    inputs:
      JAVA_VERSION:
        required: true
        type: string
    secrets:
      NVD_API_KEY:
        required: true

jobs:
  # Job 1: Unit Tests and Static Analysis
  backend_checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven

      # 1) Unit tests + JaCoCo
      - name: Run backend unit tests + JaCoCo
        run: ./mvnw -B clean test

      # 2) Static analysis (Checkstyle, PMD, SpotBugs) without re-running tests
      - name: Repo hygiene (Checkstyle, PMD, SpotBugs+FindSecBugs)
        run: ./mvnw -B verify -DskipUTs=true -DskipITs=true

      - name: Upload backend test reports (Surefire)
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-test-results
          path: backend/target/surefire-reports
          if-no-files-found: error

      - name: Upload backend coverage (JaCoCo)
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-test-coverage
          path: backend/target/site/jacoco
          if-no-files-found: error

  # Job 2: Dependency Scanning and SBOM Generation
  backend_security:
    runs-on: ubuntu-latest
    needs: backend_checks # Run after unit tests pass
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven

      # Cache Dependency-Check's local DB (CVE data)
      - name: Cache OWASP Dependency-Check data
        uses: actions/cache@v4
        with:
          path: ~/.org.owasp/dependency-check
          key: ${{ runner.os }}-owasp-dc-v12-1-9-${{ hashFiles('backend/pom.xml') }}

      - name: OWASP Dependency-Check (Maven)
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          ./mvnw -B \
            -Dnvd.api.key="${NVD_API_KEY}" \
            -Ddependency-check.skip=false \
            -DskipUTs=true \
            -DskipITs=true \
            -DskipTests=true \
            org.owasp:dependency-check-maven:check

      - name: Upload OWASP Dependency-Check report
        uses: actions/upload-artifact@v4
        with:
          name: backend-dependency-vuln-report
          path: backend/target/dependency-check-report/**
          if-no-files-found: error

      - name: Generate Backend SBOM
        run: |
          # This executes the cyclonedx plugin (bound to 'package' phase)
          ./mvnw -B clean package -DskipTests -Djacoco.skip=true

      - name: Upload Backend SBOM
        uses: actions/upload-artifact@v4
        with:
          name: backend-sbom-report
          path: backend/target/sbom/backend-sbom.json
          if-no-files-found: error

  # Job 3: Integration Tests
  backend_integration_test:
    runs-on: ubuntu-latest
    needs: backend_security # Run after security/build step completes
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven

      # Docker is already available on ubuntu-latest; no extra setup needed
      - name: Run backend integration tests (Failsafe + Testcontainers)
        env:
          # optional but common in CI to simplify container cleanup
          TESTCONTAINERS_RYUK_DISABLED: true
        run: ./mvnw -B verify -DskipUTs=true

      - name: Upload backend integration test reports (Failsafe)
        uses: actions/upload-artifact@v4
        with:
          name: backend-it-test-results
          path: backend/target/failsafe-reports
          if-no-files-found: error
