# .github/workflows/backend-ci.yml
name: Backend CI

on:
  workflow_call:
    inputs:
      JAVA_VERSION:
        required: true
        type: string
    secrets:
      NVD_API_KEY:
        required: true

jobs:
  # 1. Job A: Unit Tests (Independent)
  backend_unit_tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven

      - name: Run backend unit tests + JaCoCo
        run: ./mvnw -B clean test

      - name: Upload backend test reports (Surefire)
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-test-results
          path: backend/target/surefire-reports
          if-no-files-found: error

      - name: Upload backend coverage (JaCoCo)
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-test-coverage
          path: backend/target/site/jacoco
          if-no-files-found: error

  # 2. Job B: Static Analysis (Independent)
  backend_static_analysis:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven

      - name: Repo hygiene (Checkstyle, PMD, SpotBugs+FindSecBugs)
        run: ./mvnw -B verify -DskipUTs=true -DskipITs=true

  # 3. Job C: Build Artifacts (Critical Path)
  # FAST: Only builds the JAR. Does not run scans.
  backend_build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven

      # Build JAR & SBOM only. Skip all slow checks.
      - name: Build JAR and SBOM
        run: ./mvnw -B clean package -DskipTests -Djacoco.skip=true

      - name: Upload Backend SBOM
        uses: actions/upload-artifact@v4
        with:
          name: backend-sbom-report
          path: backend/target/sbom/backend-sbom.json
          if-no-files-found: error

      - name: Upload Backend JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          if-no-files-found: error

  # 3.5 Job D: Trivy Dependency Scan (Parallel & Fast)
  # Replaces OWASP Maven Plugin. Scans backend/pom.xml directly.
  backend_trivy_scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    # Optimization: Only run if pom.xml changed, or on main/schedule
    if: |
      github.ref == 'refs/heads/main' || 
      github.event_name == 'schedule' || 
      contains(github.event.pull_request.changed_files, 'pom.xml')
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "fs"
          scan-ref: "backend" # Only scan the backend folder
          format: "sarif"
          output: "trivy-backend-deps.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-backend-deps.sarif
          category: backend-dependencies

  # 4. Job E: Integration Tests (Optimized)
  backend_integration_test:
    runs-on: ubuntu-latest
    # Depends ONLY on the build, not the security scan
    needs: [backend_unit_tests, backend_static_analysis, backend_build]
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.JAVA_VERSION }}
          cache: maven
      - name: Run backend integration tests (Failsafe + Testcontainers)
        env:
          TESTCONTAINERS_RYUK_DISABLED: true
        run: ./mvnw -B verify -DskipUTs=true
      - name: Upload backend integration test reports (Failsafe)
        uses: actions/upload-artifact@v4
        with:
          name: backend-it-test-results
          path: backend/target/failsafe-reports
          if-no-files-found: error
