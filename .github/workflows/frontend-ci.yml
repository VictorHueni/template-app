# .github/workflows/frontend-ci.yml
name: Frontend CI

on:
  workflow_call:
    inputs:
      NODE_VERSION:
        required: true
        type: string

jobs:
  # 1. Job A: Linting (Independent)
  frontend_lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Prettier check
        run: npm run format:check

  # 2. Job B: Type Checking & Static Analysis (Independent)
  frontend_static_checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Type check
        run: npm run typecheck

  # 3. Job C: Unit Tests and Coverage (Independent)
  frontend_unit_tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Unit tests with coverage (Vitest)
        run: npm run test:coverage

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-test-coverage
          path: frontend/coverage
          if-no-files-found: error

  # # 4. Job D: Security and Licensing Reports (Your existing Job 2, already independent)
  frontend_security_and_licenses:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      # JS vuln scanning (osv-scanner)
      - name: Download osv-scanner
        run: |
          curl -sSfL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 \
            -o /usr/local/bin/osv-scanner
          chmod +x /usr/local/bin/osv-scanner

      - name: Scan frontend dependencies with osv-scanner
        working-directory: frontend
        run: |
          osv-scanner --lockfile=package-lock.json

      # SBOM (CycloneDX) â€“ no devDependencies
      - name: Generate CycloneDX SBOM for frontend
        working-directory: frontend
        run: |
          mkdir -p ../artifacts
          npx @cyclonedx/cyclonedx-npm@latest \
            --output-format json \
            --omit dev \
            --output-file ../artifacts/frontend-sbom.json

      # License report (production deps only)
      - name: Generate frontend license report
        working-directory: frontend
        run: |
          mkdir -p ../artifacts
          npx license-checker-rseidelsohn@latest \
            --json \
            --production \
            --out ../artifacts/frontend-licenses.json

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dependency-and-license-reports
          path: artifacts
          if-no-files-found: ignore
