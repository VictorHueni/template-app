# .github/workflows/frontend-ci.yml
name: Frontend CI

on:
  workflow_call:
    inputs:
      NODE_VERSION:
        required: true
        type: string

jobs:
  # 1. Job A: Linting (Independent)
  frontend_lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Generate API client
        run: npm run api:generate

      - name: Lint
        run: npm run lint

      - name: Prettier check
        run: npm run format:check

  # 2. Job B: Type Checking & Static Analysis (Independent)
  frontend_static_checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Generate API client
        run: npm run api:generate

      - name: Type check
        run: npm run typecheck

  # 3. Job C: Unit Tests and Coverage (Independent)
  frontend_unit_tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Generate API client
        run: npm run api:generate

      - name: Unit tests with coverage (Vitest)
        run: npm run test:coverage

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-test-coverage
          path: frontend/coverage
          if-no-files-found: error

  # # 4. Job D: Security and Licensing Reports (Your existing Job 2, already independent)
  frontend_security_and_licenses:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      # JS vuln scanning (osv-scanner)
      - name: Download osv-scanner
        run: |
          curl -sSfL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 \
            -o /usr/local/bin/osv-scanner
          chmod +x /usr/local/bin/osv-scanner

      - name: Scan frontend dependencies with osv-scanner
        working-directory: frontend
        run: |
          osv-scanner --lockfile=package-lock.json

      # SBOM (CycloneDX) â€“ no devDependencies
      - name: Generate CycloneDX SBOM for frontend
        working-directory: frontend
        run: |
          mkdir -p ../artifacts
          npx @cyclonedx/cyclonedx-npm@latest \
            --output-format json \
            --omit dev \
            --output-file ../artifacts/frontend-sbom.json

      # License report (production deps only)
      - name: Generate frontend license report
        working-directory: frontend
        run: |
          mkdir -p ../artifacts
          npx license-checker-rseidelsohn@latest \
            --json \
            --production \
            --out ../artifacts/frontend-licenses.json

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dependency-and-license-reports
          path: artifacts
          if-no-files-found: ignore

  frontend_sonar_scan:
    name: Frontend Quality Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Sonar to assign issues to authors

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION || '20' }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      # 1. GENERATE COVERAGE
      # This runs 'vitest run --coverage' defined in your package.json
      - name: Run Unit Tests with Coverage
        run: npm run test:coverage

      # 2. Generate Lint Report (Required for Code Smells)
      # We run this HERE so the file exists for the next step.
      - name: Generate Linting Report
        run: npm run lint:report
        continue-on-error: true # Important! Let Sonar report the errors, don't stop here.

      # 2. RUN SONAR SCAN
      # We pass configuration via args instead of creating a file
      - name: SonarQube Cloud Scan
        uses: sonarsource/sonarqube-scan-action@v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: frontend
          args: >
            -Dsonar.projectKey=template-app-frontend
            -Dsonar.organization=victorhueni
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.tsx,**/*.test.ts,**/*.spec.ts
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.eslint.reportPaths=eslint-report.json
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/e2e/**,**/src/api/generated/**,**/*.spec.ts,**/*.test.tsx
            -Dsonar.coverage.exclusions=**/src/api/generated/**,**/src/vite-env.d.ts,**/src/main.tsx
