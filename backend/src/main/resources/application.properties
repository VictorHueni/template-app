# ========================================
# BASE APPLICATION CONFIGURATION
# ========================================
# Common configuration shared across all profiles
# Profile-specific: application-{profile}.properties

# ========================================
# 1. APPLICATION SETTINGS
# ========================================
spring.application.name=demo

# Default profile (used when no profile is explicitly set)
spring.profiles.default=local

# ========================================
# 2. SESSION & COOKIE CONFIGURATION (ALL PROFILES)
# ========================================
# Disable URL-based session tracking for maximum security
server.servlet.session.tracking-modes=COOKIE

# Set SameSite=Strict to mitigate CSRF (fixes ZAP 10054)
server.servlet.session.cookie.same-site=strict

# Add HttpOnly (prevents client-side script access to the cookie)
server.servlet.session.cookie.http-only=true

# Add Secure (ensure cookie is only sent over HTTPS/SSL)
# Default is false for local/dev (HTTP), override to true in production profile
server.servlet.session.cookie.secure=${COOKIE_SECURE:false}

# ========================================
# 3. ERROR HANDLING CONFIGURATION
# ========================================
# Enable RFC 7807 Problem Details for HTTP APIs (Spring Boot 3+)


# ========================================
# 4. ACTUATOR CONFIGURATION (DEFAULT)
# ========================================
# These can be overridden in profile-specific files
# Security: Use custom base path to obscure actuator endpoints from scanners
management.endpoints.web.base-path=/management
management.endpoints.web.exposure.include=health
management.endpoint.health.show-details=when-authorized

# ========================================
# 5. SECURITY FILTER REGISTRATION
# ========================================
# Force Spring Security to run on Error and Forward dispatches so headers are written to 404 pages
spring.security.filter.dispatcher-types=request,async,error,forward,include

# ========================================
# 6. HIBERNATE ENVERS CONFIGURATION
# ========================================
# Audit table suffix (creates greeting_aud for greeting table - lowercase per naming convention)
spring.jpa.properties.org.hibernate.envers.audit_table_suffix=_aud
# Revision field names in audit tables
spring.jpa.properties.org.hibernate.envers.revision_field_name=rev
spring.jpa.properties.org.hibernate.envers.revision_type_field_name=revtype
# Store entity data when deleted (enables full audit trail)
spring.jpa.properties.org.hibernate.envers.store_data_at_delete=true
# ValidityAuditStrategy: Adds REVEND column for faster historical queries
# Uses range conditions instead of correlated subqueries for point-in-time lookups
spring.jpa.properties.org.hibernate.envers.audit_strategy=org.hibernate.envers.strategy.internal.ValidityAuditStrategy

# ========================================
# 7. SPRING MODULITH CONFIGURATION
# ========================================
# Disable automatic schema initialization (Flyway manages event_publication table)
spring.modulith.events.jdbc.schema-initialization.enabled=false

# Completion mode: DELETE removes events from outbox after successful delivery
# This keeps the technical outbox table lean (vs. ARCHIVE which marks as completed)
spring.modulith.events.completion-mode=DELETE

# ========================================
# 8. MICROMETER TRACING CONFIGURATION
# ========================================
# Enable tracing for distributed trace_id propagation
management.tracing.enabled=true
management.tracing.sampling.probability=1.0

# ========================================
# 9. FLYWAY CONFIGURATION
# ========================================
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=0

# Enable Spring Modulith's module-aware Flyway migrations support
# This ensures proper initialization ordering between Flyway execution
# and Hibernate schema validation, particularly important for:
# - Integration tests with Testcontainers and @ApplicationModuleTest
# - Local development with PostgreSQL
# - Production deployments
# Requires: spring-modulith-runtime on classpath
spring.modulith.runtime.flyway-enabled=false

# Disable legacy script initialization (replaced by Flyway)
spring.sql.init.mode=never

# ========================================
# 10. JPA NAMING STRATEGY (MODERN SQL)
# ========================================
# Use custom Implicit strategy to handle @Module prefixes and explicit constraint naming (pk_, fk_, ix_)
spring.jpa.hibernate.naming.implicit-strategy=com.example.demo.common.config.AppImplicitNamingStrategy
# Use standard Spring Physical strategy (CamelCase -> snake_case)
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy

# ========================================
# 11. WEB SERVER CONFIGURATION (ALL PROFILES)
# ========================================
# API context path - same across all environments
server.servlet.context-path=/api

# ========================================
# 12. HIBERNATE CONFIGURATION (DEFAULT)
# ========================================
# UTC timezone for all database operations - consistent across all environments
spring.jpa.properties.hibernate.jdbc.time_zone=UTC

# Format SQL for readability - default false, override to true in dev/local for debugging
spring.jpa.properties.hibernate.format_sql=false

# Show SQL statements - default false, override to true in local for visibility
spring.jpa.properties.hibernate.show_sql=false

# Open session in view - default false, override to true in dev/local where needed
spring.jpa.open-in-view=false

# Defer datasource initialization - default true, override to false in local/integration for test compatibility
spring.jpa.defer-datasource-initialization=true

# ========================================
# 13. SECURITY CONFIGURATION (DEFAULT)
# ========================================
# Default admin username - can be overridden via ${ADMIN_USERNAME} environment variable
admin.username=admin