# ========================================
# TEST PROFILE
# ========================================
# Base test configuration - H2 for unit tests (@DataJpaTest), Testcontainers PostgreSQL for integration tests
# Activated via @ActiveProfiles("test")

# ========================================
# 0. SPRING ADDONS OIDC AUTO-CONFIGURATION EXCLUSION
# ========================================
# Disable Spring Addons OIDC auto-configuration in test profile
# This allows TestSecurityConfig to define a permitAll security filter chain
# without conflicting with Spring Addons' resource server filter chain
spring.autoconfigure.exclude=com.c4_soft.springaddons.security.oidc.starter.synchronised.resourceserver.SpringAddonsOidcResourceServerBeans

# ========================================
# 1. DATABASE CONFIGURATION
# ========================================
# H2 in-memory database for unit tests (overridden by Testcontainers @ServiceConnection in integration tests)
spring.datasource.url=jdbc:h2:mem:testdb;DATABASE_TO_LOWER=TRUE;DEFAULT_NULL_ORDERING=HIGH
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver

# Minimal connection pool for test execution
spring.datasource.hikari.maximum-pool-size=5
spring.datasource.hikari.minimum-idle=1
spring.datasource.hikari.connection-timeout=10000

# ========================================
# 2. JPA/HIBERNATE CONFIGURATION
# ========================================
# Create-drop mode for H2 unit tests (application-integration.properties overrides to validate)
spring.jpa.hibernate.ddl-auto=create-drop
# Note: Do NOT set hibernate.dialect - allows Hibernate to auto-detect (H2 for unit tests, PostgreSQL for Testcontainers)

# Note: format_sql, show_sql, jdbc.time_zone, open_in_view inherited from base

# SQL initialization enabled to complement Hibernate DDL (required for FunctionalIdGenerator PostgreSQL sequences)
spring.sql.init.mode=always
spring.jpa.defer-datasource-initialization=true

# ========================================
# 3. WEB SERVER CONFIGURATION
# ========================================
# Random port for parallel test execution to avoid conflicts
server.port=0

# Note: server.servlet.context-path inherited from base

# ========================================
# 4. SECURITY CONFIGURATION
# ========================================
# TestSecurityConfig active (@Profile("test")) - all endpoints public, no authentication required
# CORS and admin credentials not used in test environment

# Cookie secure inherited from application.properties (false)

# ========================================
# 5. ACTUATOR CONFIGURATION
# ========================================
# Minimal actuator exposure for tests (health only, consistent with production security)
management.endpoints.web.exposure.include=health
management.endpoint.health.show-details=when-authorized
management.endpoint.health.probes.enabled=false

# ========================================
# 6. LOGGING CONFIGURATION
# ========================================
# Balanced logging to reduce test output noise while providing debugging context
logging.level.root=WARN
logging.level.com.example.demo=DEBUG
logging.level.org.springframework=WARN
logging.level.org.springframework.boot.actuate=WARN
logging.level.org.springframework.security=INFO
logging.level.org.springframework.web=INFO
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
logging.level.org.springframework.jdbc.core=DEBUG

# Testcontainers logging for integration test visibility
logging.level.org.testcontainers=INFO
logging.level.tc=INFO

# Log pattern for test output readability
logging.pattern.console=%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n

# ========================================
# 7. ERROR HANDLING
# ========================================
# Show all details for test debugging and assertions
spring.web.error.include-binding-errors=always
spring.web.error.include-message=always
spring.web.error.include-stacktrace=always

# ========================================
# 8. TESTCONTAINERS CONFIGURATION
# ========================================
# Testcontainers automatically detected via @ServiceConnection on test class
# No explicit configuration needed - TestcontainersConfiguration.java provides singleton PostgreSQL container

# ========================================
# 9. FLYWAY CONFIGURATION
# ========================================
# Disable Flyway for H2 unit tests (uses Hibernate DDL instead via create-drop mode)
# Integration tests override via application-integration.properties to enable Flyway with PostgreSQL
spring.flyway.enabled=false

# ========================================
# 10. SPRING MODULITH CONFIGURATION
# ========================================
# Re-enable Spring Modulith auto-schema for H2 unit tests (Flyway handles it in integration tests)
spring.modulith.events.jdbc.schema-initialization.enabled=true
