# ========================================
# INTEGRATION TEST PROFILE
# ========================================
# PostgreSQL Testcontainers integration tests - extends base 'test' profile
# Activated via @ActiveProfiles({"test", "integration"})
# Uses Testcontainers @ServiceConnection to provide real PostgreSQL container

# ========================================
# 1. DATABASE CONFIGURATION
# ========================================
# Testcontainers @ServiceConnection auto-configures PostgreSQL connection at runtime
# No explicit datasource URL/credentials needed - provided by TestcontainersConfiguration.java
# Connection pool sized for test container resource constraints

spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=2
spring.datasource.hikari.connection-timeout=30000

# ========================================
# 2. JPA/HIBERNATE CONFIGURATION
# ========================================
# Validate mode: schema must match Flyway migrations (no auto DDL with PostgreSQL)
spring.jpa.hibernate.ddl-auto=validate
# Note: Dialect auto-detected by Hibernate from Testcontainers PostgreSQL JDBC connection

# Note: format_sql, show_sql, jdbc.time_zone, open_in_view inherited from base

# Disable SQL initialization when using Flyway for schema management
spring.sql.init.mode=never
spring.jpa.defer-datasource-initialization=false

# ========================================
# 3. WEB SERVER CONFIGURATION
# ========================================
# Random port for parallel test execution to avoid port conflicts
server.port=0

# Note: server.servlet.context-path inherited from base

# ========================================
# 4. SECURITY CONFIGURATION
# ========================================
# TestSecurityConfig active - all endpoints public, no authentication required for integration tests
# CORS and admin credentials not used in test environment

# Cookie secure inherited from application.properties (false)

# ========================================
# 5. ACTUATOR CONFIGURATION
# ========================================
# Minimal actuator exposure - health endpoint only for test consistency
management.endpoints.web.exposure.include=health
management.endpoint.health.show-details=when-authorized
management.endpoint.health.probes.enabled=false

# ========================================
# 6. LOGGING CONFIGURATION
# ========================================
# Balanced logging with Flyway debug for troubleshooting migration issues
logging.level.root=WARN
logging.level.com.example.demo=DEBUG
logging.level.org.springframework=WARN
logging.level.org.springframework.boot.actuate=WARN
logging.level.org.springframework.security=INFO
logging.level.org.springframework.web=INFO
logging.level.org.hibernate=DEBUG

# Flyway debug logging to diagnose migration issues in integration tests
logging.level.org.flywaydb=DEBUG
logging.level.org.flywaydb.core.internal=DEBUG

# Testcontainers logging for container lifecycle visibility
logging.level.org.testcontainers=INFO
logging.level.tc=INFO

# Log pattern for test output readability
logging.pattern.console=%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n

# ========================================
# 7. ERROR HANDLING
# ========================================
# Show all details for test debugging and assertions
spring.web.error.include-binding-errors=always
spring.web.error.include-message=always
spring.web.error.include-stacktrace=always

# ========================================
# 8. TESTCONTAINERS CONFIGURATION
# ========================================
# @ServiceConnection annotation on test class auto-detects and configures Testcontainers PostgreSQL
# TestcontainersConfiguration.java provides singleton container for all integration tests
# Container lifecycle: started once, reused across test classes (testcontainers.reuse.enable=true)

# ========================================
# 9. FLYWAY CONFIGURATION
# ========================================
# Enable Flyway to validate and manage PostgreSQL schema in Testcontainers
spring.flyway.enabled=false

# Note: baseline-on-migrate, baseline-version, locations, and runtime.flyway-enabled inherited from base

# ========================================
# 10. SPRING MODULITH CONFIGURATION
# ========================================
# Disable auto-schema for event_publication table (Flyway manages all schema for PostgreSQL)
spring.modulith.events.jdbc.schema-initialization.enabled=false

